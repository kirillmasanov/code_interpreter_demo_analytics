/* ── State ─────────────────────────────────────────────── */
const state = {
  files: [],        // {file_id, filename, columns, preview_rows, row_count}
  artifacts: [],    // {file_id, filename}  — files generated by Code Interpreter
  currentStep: 1,
  maxStep: 1,
};

/* ── DOM refs ─────────────────────────────────────────── */
const $dropZone        = document.getElementById('drop-zone');
const $fileInput       = document.getElementById('file-input');
const $filesList       = document.getElementById('files-list');
const $previewSection  = document.getElementById('preview-section');
const $previewContainer= document.getElementById('preview-container');
const $btnToAnalysis   = document.getElementById('btn-to-analysis');
const $sampleDatasets  = document.getElementById('sample-datasets');
const $queryInput      = document.getElementById('query-input');
const $filesSummary    = document.getElementById('files-summary');
const $btnBackUpload   = document.getElementById('btn-back-upload');
const $btnRunAnalysis  = document.getElementById('btn-run-analysis');
const $statusBar       = document.getElementById('status-bar');
const $statusText      = document.getElementById('status-text');
const $codePanel       = document.getElementById('code-panel');
const $codeOutput      = document.getElementById('code-output');
const $codeStatus      = document.getElementById('code-status');
const $textOutput      = document.getElementById('text-output');
const $textContent     = document.getElementById('text-content');
const $chartsSection   = document.getElementById('charts-section');
const $chartsContainer = document.getElementById('charts-container');
const $exportSection   = document.getElementById('export-section');
const $exportButtons   = document.getElementById('export-buttons');
const $btnNewQuery     = document.getElementById('btn-new-query');
const $btnStartOver    = document.getElementById('btn-start-over');

/* ── Navigation ───────────────────────────────────────── */
function goToStep(n) {
  if (n > state.maxStep) state.maxStep = n;
  state.currentStep = n;

  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(`screen-${['upload','query','results'][n-1]}`).classList.add('active');

  document.querySelectorAll('.step').forEach(s => {
    const sn = +s.dataset.step;
    s.classList.remove('active', 'completed');
    if (sn === n) s.classList.add('active');
    else if (sn < n) s.classList.add('completed');
  });

  document.querySelectorAll('.step__line').forEach((line, i) => {
    line.classList.remove('active', 'completed');
    if (i + 2 <= state.maxStep) {
      line.classList.add('completed');
    }
  });
}

document.querySelectorAll('.step').forEach(btn => {
  btn.addEventListener('click', () => {
    const target = +btn.dataset.step;
    if (target <= state.maxStep) goToStep(target);
  });
});

/* ── Upload placeholders ──────────────────────────────── */
function showUploadPlaceholders(names) {
  $filesList.hidden = false;
  const placeholders = [];
  for (const name of names) {
    const id = 'upload-ph-' + Math.random().toString(36).slice(2, 8);
    const div = document.createElement('div');
    div.className = 'file-item file-item--uploading';
    div.id = id;
    div.innerHTML = `
      <div class="file-item__info">
        <div class="file-item__icon file-item__icon--pulse">CSV</div>
        <div>
          <div class="file-item__name">${name}</div>
          <div class="file-item__meta file-item__meta--loading">
            <span class="spinner-sm"></span> Загрузка…
          </div>
        </div>
      </div>`;
    $filesList.appendChild(div);
    placeholders.push(id);
  }
  return placeholders;
}

function removeUploadPlaceholders(ids) {
  for (const id of ids) {
    const el = document.getElementById(id);
    if (el) el.remove();
  }
}

/* ── File upload ──────────────────────────────────────── */
$dropZone.addEventListener('dragover', e => { e.preventDefault(); $dropZone.classList.add('dragover'); });
$dropZone.addEventListener('dragleave', () => $dropZone.classList.remove('dragover'));
$dropZone.addEventListener('drop', e => {
  e.preventDefault();
  $dropZone.classList.remove('dragover');
  handleFiles(e.dataTransfer.files);
});
$dropZone.addEventListener('click', (e) => {
  if (e.target.closest('label')) return;
  $fileInput.click();
});
$fileInput.addEventListener('change', () => {
  handleFiles($fileInput.files);
  $fileInput.value = '';
});

async function handleFiles(fileList) {
  const arr = Array.from(fileList).filter(f => f.name.endsWith('.csv'));
  if (!arr.length) return;
  const allowed = 3 - state.files.length;
  const batch = arr.slice(0, allowed);
  if (!batch.length) return;

  $dropZone.classList.add('uploading');
  const phIds = showUploadPlaceholders(batch.map(f => f.name));

  const fd = new FormData();
  batch.forEach(f => fd.append('files', f));

  try {
    const res = await fetch('/api/upload', { method: 'POST', body: fd });
    const data = await res.json();
    state.files.push(...data);
    renderFiles();
  } catch (err) {
    console.error('Upload error:', err);
  } finally {
    removeUploadPlaceholders(phIds);
    $dropZone.classList.remove('uploading');
  }
}

/* ── Load sample datasets list ─────────────────────────── */
async function loadSampleDatasets() {
  try {
    const res = await fetch('/api/sample-data');
    const samples = await res.json();
    renderSampleDatasets(samples);
  } catch (err) {
    console.error('Failed to load sample datasets:', err);
  }
}

function renderSampleDatasets(samples) {
  $sampleDatasets.innerHTML = '';
  if (!samples.length) {
    $sampleDatasets.innerHTML = '<span class="sample-datasets__empty">Нет доступных датасетов</span>';
    return;
  }
  samples.forEach(s => {
    const alreadyLoaded = state.files.some(f => f.filename === s.filename);
    const btn = document.createElement('button');
    btn.className = 'sample-chip' + (alreadyLoaded ? ' sample-chip--loaded' : '');
    btn.disabled = alreadyLoaded;
    btn.dataset.filename = s.filename;
    btn.innerHTML = `
      <svg width="14" height="14" viewBox="0 0 16 16" fill="none"><path d="M3 3h10v10H3z" stroke="currentColor" stroke-width="1.2"/><path d="M6 1v4M10 1v4" stroke="currentColor" stroke-width="1.2"/></svg>
      <span class="sample-chip__name">${s.filename}</span>
      <span class="sample-chip__meta">${s.row_count} строк · ${s.columns.length} колонок</span>
      ${alreadyLoaded ? '<span class="sample-chip__check">✓</span>' : ''}`;
    $sampleDatasets.appendChild(btn);
  });
}

$sampleDatasets.addEventListener('click', async (e) => {
  const btn = e.target.closest('.sample-chip');
  if (!btn || btn.disabled) return;
  const filename = btn.dataset.filename;
  if (state.files.length >= 3) return;

  btn.disabled = true;
  btn.classList.add('sample-chip--loading');

  $dropZone.classList.add('uploading');
  const phIds = showUploadPlaceholders([filename]);

  try {
    const res = await fetch('/api/upload-sample', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify([filename]),
    });
    const data = await res.json();
    state.files.push(...data);
    renderFiles();
    btn.classList.remove('sample-chip--loading');
    btn.classList.add('sample-chip--loaded');
    btn.innerHTML = btn.innerHTML.replace(/<span class="sample-chip__check">.*?<\/span>/, '') +
      '<span class="sample-chip__check">✓</span>';
  } catch (err) {
    console.error('Sample upload error:', err);
    btn.disabled = false;
    btn.classList.remove('sample-chip--loading');
  } finally {
    removeUploadPlaceholders(phIds);
    $dropZone.classList.remove('uploading');
  }
});

loadSampleDatasets();

function refreshSampleChips() {
  $sampleDatasets.querySelectorAll('.sample-chip').forEach(btn => {
    const loaded = state.files.some(f => f.filename === btn.dataset.filename);
    btn.disabled = loaded || state.files.length >= 3;
    btn.classList.toggle('sample-chip--loaded', loaded);
    const check = btn.querySelector('.sample-chip__check');
    if (loaded && !check) {
      btn.insertAdjacentHTML('beforeend', '<span class="sample-chip__check">✓</span>');
    } else if (!loaded && check) {
      check.remove();
    }
  });
}

/* ── Render uploaded files ────────────────────────────── */
function renderFiles() {
  $filesList.innerHTML = '';
  $previewContainer.innerHTML = '';
  refreshSampleChips();

  if (state.files.length === 0) {
    $filesList.hidden = true;
    $previewSection.hidden = true;
    $btnToAnalysis.disabled = true;
    return;
  }

  $filesList.hidden = false;
  $previewSection.hidden = false;
  $btnToAnalysis.disabled = false;

  state.files.forEach((f, idx) => {
    const div = document.createElement('div');
    div.className = 'file-item';
    div.innerHTML = `
      <div class="file-item__info">
        <div class="file-item__icon">CSV</div>
        <div>
          <div class="file-item__name">${f.filename}</div>
          <div class="file-item__meta">${f.columns.length} колонок · ${f.row_count} строк</div>
        </div>
      </div>
      <button class="file-item__remove" data-file-idx="${idx}" title="Удалить">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M4 4l8 8M12 4l-8 8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
      </button>`;
    $filesList.appendChild(div);

    const card = document.createElement('div');
    card.className = 'preview-card';
    card.innerHTML = `
      <div class="preview-card__header">${f.filename}</div>
      <div class="preview-table-wrap">
        <table class="preview-table">
          <thead><tr>${f.columns.map(c => `<th>${c}</th>`).join('')}</tr></thead>
          <tbody>${f.preview_rows.map(r => `<tr>${r.map(v => `<td>${v}</td>`).join('')}</tr>`).join('')}</tbody>
        </table>
      </div>`;
    $previewContainer.appendChild(card);
  });
}

/* ── Delegated remove handler ─────────────────────────── */
$filesList.addEventListener('click', async (e) => {
  const btn = e.target.closest('.file-item__remove');
  if (!btn) return;
  const idx = +btn.dataset.fileIdx;
  const file = state.files[idx];
  if (!file) return;
  if (file.file_id) {
    try { await fetch(`/api/files/${file.file_id}`, { method: 'DELETE' }); } catch {}
  }
  state.files.splice(idx, 1);
  renderFiles();
});

/* ── Step navigation buttons ──────────────────────────── */
$btnToAnalysis.addEventListener('click', () => {
  $filesSummary.innerHTML = state.files
    .map(f => `<span class="files-summary__tag"><svg width="14" height="14" viewBox="0 0 16 16" fill="none"><path d="M3 3h10v10H3z" stroke="currentColor" stroke-width="1.2"/></svg>${f.filename}</span>`)
    .join('');
  goToStep(2);
});

$btnBackUpload.addEventListener('click', () => goToStep(1));
$btnNewQuery.addEventListener('click', () => goToStep(2));

$btnStartOver.addEventListener('click', async () => {
  const allFiles = [
    ...state.files.map(f => f.file_id),
    ...state.artifacts.map(f => f.file_id),
  ].filter(Boolean);

  await Promise.allSettled(
    allFiles.map(id => fetch(`/api/files/${id}`, { method: 'DELETE' }))
  );

  state.files = [];
  state.artifacts = [];
  state.maxStep = 1;
  renderFiles();
  resetResults();
  goToStep(1);
});

/* ── Prompt chips ─────────────────────────────────────── */
document.querySelectorAll('.chip').forEach(chip => {
  chip.addEventListener('click', () => {
    $queryInput.value = chip.dataset.prompt;
    $queryInput.focus();
  });
});

/* ── Run analysis ─────────────────────────────────────── */
$btnRunAnalysis.addEventListener('click', startAnalysis);

function startAnalysis() {
  const query = $queryInput.value.trim();
  if (!query) return;

  state.artifacts = [];
  resetResults();
  goToStep(3);

  const fileIds = state.files.map(f => f.file_id).filter(Boolean);
  const params = new URLSearchParams();
  params.set('query', query);
  fileIds.forEach(id => params.append('file_ids', id));

  const evtSource = new EventSource(`/api/analyze?${params}`);
  handleSSE(evtSource);
}

/* ── Reset results UI ─────────────────────────────────── */
function resetResults() {
  $codeOutput.textContent = '';
  $codeStatus.textContent = '';
  $codeStatus.className = 'code-status';
  $textContent.innerHTML = '';
  $textOutput.hidden = true;
  $chartsContainer.innerHTML = '';
  $chartsSection.hidden = true;
  $exportButtons.innerHTML = '';
  $exportSection.hidden = true;
  $statusBar.className = 'status-bar';
  $statusText.textContent = 'Подключение к модели...';
}

/* ── SSE handler ──────────────────────────────────────── */
function handleSSE(evtSource) {
  let textBuffer = '';
  let hadDeltas = false;
  let codeShownForBlock = 0;
  const t0 = Date.now();
  let timerInterval = null;

  function elapsed() {
    return ((Date.now() - t0) / 1000).toFixed(0);
  }

  function setStatus(msg) {
    $statusText.textContent = `${msg} (${elapsed()}с)`;
  }

  timerInterval = setInterval(() => {
    const current = $statusText.textContent.replace(/\s*\(\d+с\)$/, '');
    $statusText.textContent = `${current} (${elapsed()}с)`;
  }, 1000);

  function stopTimer() {
    if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
  }

  function on(event, cb) {
    evtSource.addEventListener(event, e => cb(JSON.parse(e.data)));
  }

  on('processing', () => {
    setStatus('Модель обрабатывает запрос…');
  });

  on('reasoning_delta', () => {
    setStatus('Модель размышляет…');
  });

  on('code_delta', d => {
    hadDeltas = true;
    setStatus('Генерация кода…');
    $codeOutput.textContent += d.delta;
    $codeStatus.textContent = 'Генерация';
    $codeStatus.className = 'code-status running';
    $codeOutput.parentElement.scrollTop = $codeOutput.parentElement.scrollHeight;
  });

  on('code_generated', d => {
    const block = d.block || 0;
    if (!hadDeltas && d.code) {
      $codeOutput.textContent += d.code;
      codeShownForBlock = block;
    } else if (hadDeltas) {
      codeShownForBlock = block;
    }
    hadDeltas = false;
    $codeOutput.textContent += '\n# ── Код сгенерирован (блок ' + block + ') ──\n';
    setStatus('Запуск кода в контейнере (блок ' + block + ')…');
    $codeStatus.textContent = 'Выполняется';
    $codeStatus.className = 'code-status running';
    $codeOutput.parentElement.scrollTop = $codeOutput.parentElement.scrollHeight;
  });

  on('code_running', d => {
    const block = (d && d.block) || '';
    setStatus('Выполнение кода в контейнере' + (block ? ' (блок ' + block + ')' : '') + '…');
    $codeStatus.textContent = 'Выполняется';
    $codeStatus.className = 'code-status running';
  });

  on('code_interpreting', d => {
    const block = (d && d.block) || '';
    setStatus('Интерпретация результатов' + (block ? ' (блок ' + block + ')' : '') + '…');
    $codeStatus.textContent = 'Интерпретация';
    $codeStatus.className = 'code-status running';
  });

  on('code_completed', d => {
    const block = (d && d.block) || 0;
    $codeOutput.textContent += '\n# ── Выполнение завершено (блок ' + block + ') ──\n';
    setStatus('Код выполнен, анализ результатов…');
    $codeStatus.textContent = 'Готово';
    $codeStatus.className = 'code-status finished';
  });

  on('code_result', d => {
    const block = (d && d.block) || 0;
    if (d.code && codeShownForBlock < block) {
      $codeOutput.textContent += '\n' + d.code + '\n';
      codeShownForBlock = block;
    }
    if (d.outputs && d.outputs.length) {
      $codeOutput.textContent += '\n# ── Результат ──\n' + d.outputs.join('\n');
    }
    $codeOutput.parentElement.scrollTop = $codeOutput.parentElement.scrollHeight;
  });

  on('text_delta', d => {
    setStatus('Формирование ответа…');
    textBuffer += d.delta;
    $textOutput.hidden = false;
    $textContent.innerHTML = marked.parse(textBuffer);
  });

  on('files', d => {
    setStatus('Получение файлов…');
    if (!d.files || !d.files.length) return;

    d.files.forEach(f => {
      state.artifacts.push({ file_id: f.file_id, filename: f.filename });
    });

    const images = d.files.filter(f => /\.(png|jpe?g|gif|svg)$/i.test(f.filename));
    const downloads = d.files.filter(f => !/\.(png|jpe?g|gif|svg)$/i.test(f.filename));

    if (images.length) {
      $chartsSection.hidden = false;
      images.forEach(f => {
        const card = document.createElement('div');
        card.className = 'chart-card';
        card.innerHTML = `
          <img src="/api/files/${f.file_id}/download?filename=${encodeURIComponent(f.filename)}" alt="${f.filename}">
          <div class="chart-card__footer">
            <span>${f.filename}</span>
            <a href="/api/files/${f.file_id}/download?filename=${encodeURIComponent(f.filename)}" class="btn btn--small btn--outline" download>Скачать</a>
          </div>`;
        $chartsContainer.appendChild(card);
      });
    }

    if (downloads.length) {
      $exportSection.hidden = false;
      downloads.forEach(f => {
        const a = document.createElement('a');
        a.className = 'export-btn';
        a.href = `/api/files/${f.file_id}/download?filename=${encodeURIComponent(f.filename)}`;
        a.download = f.filename;
        const ext = f.filename.split('.').pop().toUpperCase();
        a.innerHTML = `<span class="export-btn__icon">${ext}</span> ${f.filename}`;
        $exportButtons.appendChild(a);
      });
    }
  });

  on('error', d => {
    stopTimer();
    $statusBar.className = 'status-bar error';
    $statusText.textContent = `Ошибка: ${d.message}`;
    evtSource.close();
  });

  on('done', () => {
    stopTimer();
    $statusBar.className = 'status-bar done';
    $statusText.textContent = `Анализ завершён за ${elapsed()}с`;
    evtSource.close();
  });

  evtSource.onerror = () => {
    stopTimer();
    $statusBar.className = 'status-bar error';
    $statusText.textContent = 'Соединение потеряно';
    evtSource.close();
  };
}
